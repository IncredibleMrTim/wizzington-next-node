name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: Install dependencies and build
        run: |
          yarn install --frozen-lockfile
          yarn build
        env:
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}

      - name: Prepare deployment files
        run: |
          mkdir -p deploy/logs deploy/systemd
          cp -r .next public package.json yarn.lock deploy/
          cp -r systemd/* deploy/systemd/
          cp next.config.ts deploy/ 2>/dev/null || cp next.config.js deploy/ 2>/dev/null || true

      - name: Deploy to VPS
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || 22 }}
          SOURCE: "deploy/"
          TARGET: ${{ secrets.DEPLOY_PATH }}
          SCRIPT_BEFORE: |
            mkdir -p ${{ secrets.DEPLOY_PATH }}
            [ -d "${{ secrets.DEPLOY_PATH }}/uploads" ] && mv ${{ secrets.DEPLOY_PATH }}/uploads ${{ secrets.DEPLOY_PATH }}/uploads_backup
          SCRIPT_AFTER: |
            cd ${{ secrets.DEPLOY_PATH }}

            # Setup directories
            mkdir -p logs uploads
            [ -d "uploads_backup" ] && rm -rf uploads && mv uploads_backup uploads

            # Create environment file
            cat > .env << 'EOF'
            NODE_ENV=production
            PORT=3000
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_PORT=${{ secrets.DB_PORT }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            UPLOAD_DIR=./uploads
            MAX_FILE_SIZE=5242880
            MAX_FILES=10
            EOF

            # Set permissions
            chmod -R 755 uploads logs

            # Install systemd service if not already installed
            if [ ! -f "/etc/systemd/system/wizz-next.service" ]; then
              echo "Installing systemd service..."
              sudo cp systemd/wizz-next.service /etc/systemd/system/
              sudo mkdir -p /var/log/wizz-next
              sudo chown $USER:$USER /var/log/wizz-next
              sudo systemctl daemon-reload
              sudo systemctl enable wizz-next
            fi

            # Install dependencies and restart
            yarn install --production --frozen-lockfile
            sudo systemctl restart wizz-next

            echo "âœ… Deployment complete"
            sudo systemctl status wizz-next --no-pager
